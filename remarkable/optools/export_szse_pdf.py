import logging
import os
from pathlib import Path
from zipfile import ZIP_DEFLATED, ZipFile

from remarkable.common.storage import localstorage
from remarkable.common.util import loop_wrapper
from remarkable.config import project_root
from remarkable.models.new_file import NewFile

logger = logging.getLogger(__name__)

zip_path = Path(project_root) / "data" / "szse_pdf.zip"

# 深交所金融数据统计准确率时需要忽略的字段
szse_stat_black = [
    "五-发行人基本情况-公司类型",
    "八-财务报表编制基础-采用的会计准则",
    "二-发行人上市标准-上市标准",
    "五-发行人基本情况-统一社会信用代码",
    "五-发行人基本情况-注册地（市区县）",
    "五-发行人基本情况-申报企业（全称）",
    "五-最近一次增资-原文",
    "五-发行人基本情况-邮编",
    "五-发行人基本情况-公司网址",
    "二-主营业务-主营业务",
    "五-发行人基本情况-公司设立时间",
    "六-主营业务-主营业务",
    "五-董监高核情况-表格-姓名",
    "五-董监高核情况-表格-董监高身份",
    "五-控股股东和实际控制人情况-护照号",
    "五-发行人基本情况-法人代表",
    "五-国有股东和外资股东情况-名称",
    "五-控股股东和实际控制人情况-身份证号",
    "五-发行人基本情况-注册地（省市或境外）",
    "五-控股股东和实际控制人情况-全称",
    "五-控股股东和实际控制人情况-职位",
    "五-发行人股本情况-股东性质",
    "二-发行人基本情况-统一社会信用代码",
    "一-释义-全称/释义",
    "一-释义-简称",
    "二-发行人基本情况-行业分类（证监会）-证监会行业细分",
    "二-发行人基本情况-注册地（市区县）",
    "五-发行人股本情况-名称",
    "二-发行人基本情况-法人代表",
    "二-发行人基本情况-申报企业（全称）",
    "二-发行人基本情况-公司设立时间",
    "五-控股股东和实际控制人情况-统一社会信用代码",
    "六-行业基本情况（证监会）-证监会行业细分",
    "八-注册会计师的审计意见-最近一期审计基准日",
    "三-本次发行的有关机构-通讯地址",
    "二-发行人基本情况-注册地（省市或境外）",
    "三-本次发行的有关机构-注册地址",
    "三-本次发行的有关机构-名称",
    "三-本次发行的有关机构-机构类型",
    "三-本次发行的有关机构-人员信息-姓名",
    "三-本次发行的有关机构-人员信息-身份",
    "二-发行人基本情况-实际控制人情况-名称",
    "五-控股股东和实际控制人情况-任职机构情况-任职机构",
    "五-国有股东和外资股东情况-股东类型",
    "二-发行人基本情况-行业分类（证监会）-证监会行业",
    "五-董监高核情况-段落-姓名",
    "五-控股股东和实际控制人情况-简称",
    "五-董监高核情况-段落-董监高身份",
    "五-最近一次增资-最近一次增资日期",
    "六-行业基本情况（证监会）-证监会行业",
    "五-员工持股与股权激励计划-是否存在股权激励计划",
    "五-控股股东和实际控制人情况-任职机构情况-任职期间",
    "三-本次发行的有关机构-人员信息-身份证号",
    "三-本次发行的有关机构-公司网址",
    "主要产品市场占有率（临时）-产品名称",
    "二-发行人基本情况-公司网址",
    "二-发行人基本情况-申报企业（简称）",
    "二-发行人基本情况-邮编",
    "五-员工持股与股权激励计划-是否存在员工持股计划",
    "五-控股股东和实际控制人情况-股票代码",
    "五-董监高核情况-段落-身份证号",
    "产品实现进口替代情况（临时）-产品名称",
    "员工持股与股权激励计划（临时）-是否存在员工持股计划",
    "员工持股与股权激励计划（临时）-是否存在股权激励计划",
    "行业基本情况（证监会）（临时）-证监会行业",
    "行业基本情况（证监会）（临时）-证监会行业细分",
    "项目基本情况表（临时）-公司类型",
    "项目基本情况表（临时）-申报企业曾用名",
    "项目基本情况表（临时）-高新技术企业",
    "员工人数表-研发人员数量（硕士及以上学历）（人）-数值",
    "五-国有股东和外资股东情况-持股比例-数值",
    "五-最近一次增资-最近一次增资前金额-数值",
    "风险因素-综合毛利率（%）-数值",
    "经营成果表-综合毛利率（%）-数值",
    "五-国有股东和外资股东情况-持股数量-数值",
    "毛利表-综合毛利率（%）-数值",
    "二-主要财务指标表-每股经营活动现金流量（元）-数值",
    "五-最近一次增资-最近一次增资后金额-数值",
    "五-最近一次增资-最近一次增资金额-数值",
    "综合毛利率（其他）-综合毛利率（%）-数值",
    "五-发行人股本情况-持股比例-数值",
    "三-本次发行的基本情况-预计募集资金净额（万元）-数值",
    "三-本次发行的基本情况-预计募集资金总额（万元）-数值",
    "三-本次发行的基本情况-拟发行量（万股）-数值",
    "偿债能力表-利息保障倍数（倍）-数值",
    "五-发行人股本情况-持股数量-数值",
    "五-发行人股本情况-总股本-发行前总股本-数值",
    "二-主要财务指标表-归属于母公司所有者的每股净资产-数值",
    "二-本次发行概况-拟发行量（万股）-数值",
    "二-本次发行概况-预计募集资金总额（万元）-数值",
    "员工薪酬表-研发人员数量（硕士及以上学历）（人）-数值",
    "二-本次发行概况-预计募集资金净额（万元）-数值",
]

SPECIAL_FILE_IDS = [
    859,
    858,
    857,
    854,
    846,
    845,
    842,
    841,
    840,
    837,
    765,
    764,
    763,
    762,
    761,
    760,
    756,
    755,
    754,
    753,
    752,
    751,
    749,
    748,
    747,
    745,
    744,
    743,
    741,
    740,
    739,
    738,
    737,
    736,
    735,
    734,
    733,
    732,
    731,
    730,
    729,
    728,
    727,
    726,
    725,
    724,
    723,
    721,
    720,
    719,
    718,
    717,
    716,
    715,
    714,
    713,
    712,
    711,
    652,
    651,
    650,
    649,
    645,
    644,
    641,
    639,
    638,
    636,
    635,
    633,
    632,
    631,
    630,
    629,
    628,
    627,
    626,
    625,
    624,
    613,
    612,
    611,
    610,
    609,
    608,
    607,
    606,
    605,
    604,
    603,
    602,
    601,
    599,
    598,
    597,
    596,
    595,
    594,
    593,
    592,
    591,
    590,
    589,
    588,
    587,
    586,
    585,
    584,
    583,
    582,
    581,
    580,
    579,
    578,
    577,
    576,
    575,
    574,
    573,
    572,
    571,
    570,
    569,
    568,
    567,
    566,
    565,
    564,
    563,
    562,
    561,
    560,
    559,
    558,
    556,
    555,
    554,
    553,
    552,
    551,
    550,
    549,
    548,
    547,
    546,
    545,
    544,
    543,
    542,
    541,
    540,
    539,
    538,
    537,
    536,
    535,
    534,
    533,
    532,
    531,
    529,
    528,
    527,
    526,
    525,
    524,
    523,
    522,
    521,
    520,
    519,
    518,
    517,
    516,
    515,
    514,
    513,
    512,
    511,
    510,
    509,
    480,
    479,
    478,
    477,
    476,
    475,
    474,
    473,
    471,
    470,
    468,
    467,
    463,
    462,
    460,
    415,
    413,
    406,
    404,
]


@loop_wrapper
async def main(start=None, end=None):
    files = await NewFile.list_by_range(start=start, end=end)
    filenames = set()
    with ZipFile(zip_path, "w", compression=ZIP_DEFLATED) as zip_fp:
        for file in files:
            if file.id not in SPECIAL_FILE_IDS:
                continue
            if not file.pdf_path():
                logger.info(f"pdf not exists, file id: {file.id}")
                continue
            pdf_path = localstorage.mount(file.pdf_path())
            if not os.path.exists(pdf_path):
                logger.info(f"pdf not exists, file id: {file.id}")
                continue
            logger.info(f"file id: {file.id}, name: {file.name}")
            if file.name in filenames:
                logger.info(f"duplicate name {file.name}")
            filenames.add(file.name)
            zip_fp.write(pdf_path, f"{file.name}")


if __name__ == "__main__":
    main()
